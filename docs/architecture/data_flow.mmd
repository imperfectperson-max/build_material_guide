graph TB
    %% Main System Entry Point
    Client(["üì± Client Apps<br/>(Web/Mobile)"]) --> API["üåê API Gateway<br/>Rate Limited & Auth"]

    subgraph "1. üîê User Authentication"
        direction TB
        Auth1["POST /auth/login<br/>User Credentials"] --> Auth2["Validate in<br/>PostgreSQL (Users)"]
        Auth2 --> Auth3["Generate JWT<br/>(15 min expiry)"]
        Auth3 --> Auth4["Return Token +<br/>Refresh Token"]
        Auth4 --> Auth5["Client Stores<br/>in Secure Storage"]
        Auth5 --> Auth6["Include in Requests:<br/>Authorization: Bearer <token>"]
        Auth6 --> Auth7{"Valid Token?"}
        Auth7 -->|Yes| Auth8["Process Request"]
        Auth7 -->|No| Auth9["Check Redis<br/>Blacklist"]
        Auth9 -->|Blacklisted| Auth10["Reject -<br/>Please Login"]
        Auth8 --> Auth11{"Logout?"}
        Auth11 -->|Yes| Auth12["Add to Redis<br/>Blacklist (15 min)"]
    end

    subgraph "2. ‚ö° Price Query - Happy Path"
        direction TB
        Price1["GET /api/prices/{material}"] --> Price2["Extract User<br/>from JWT"]
        Price2 --> Price3["Check Redis L1<br/>Cache (5 min TTL)"]
        Price3 --> Price4{"Cache Hit?"}
        Price4 -->|Yes| Price5["‚ö° Return Cached<br/>(~5ms response)"]
        Price5 --> Price6["Display to User<br/>with 'cached' badge"]
    end

    subgraph "3. üîÑ Price Query - Cache Miss"
        direction TB
        Miss1["GET /api/prices/{material}"] --> Miss2["Check Redis L1<br/>Cache (5 min TTL)"]
        Miss2 --> Miss3{"Cache Miss?"}
        Miss3 -->|Yes| Miss4["Query PostgreSQL<br/>with Optimized Index"]
        Miss4 --> Miss5["Transform Data<br/>to API Schema"]
        Miss5 --> Miss6["Store in Redis<br/>with 5 min TTL"]
        Miss6 --> Miss7["Return Fresh Data<br/>(~120ms response)"]
        Miss7 --> Miss8["Update Client Cache<br/>& Display"]
    end

    subgraph "4. ü§ñ ML Forecast - Generation"
        direction TB
        ML1["POST /api/forecasts/generate"] --> ML2["Check Redis L2<br/>Cache (6 hr TTL)"]
        ML2 --> ML3{"Cache Hit?"}
        ML3 -->|No| ML4["Load Model<br/>Version v2.3.1"]
        ML4 --> ML5["Fetch Historical<br/>Data (30 days)"]
        ML5 --> ML6["Run Prediction<br/>Pipeline"]
        ML6 --> ML7["Store in Redis<br/>(6 hr TTL)"]
        ML7 --> ML8["Return Forecast<br/>with Confidence Score"]
        ML8 --> ML9["Display Interactive<br/>Chart with Error Bounds"]
    end

    subgraph "5. üìä ML Forecast - Cached"
        direction TB
        MLC1["GET /api/forecasts/{id}"] --> MLC2["Check Redis L2<br/>Cache (6 hr TTL)"]
        MLC2 --> MLC3{"Cache Hit?"}
        MLC3 -->|Yes| MLC4["‚ö° Return Cached<br/>Forecast (<20ms)"]
        MLC4 --> MLC5["Display with<br/>'Last Updated' timestamp"]
    end

    subgraph "6. üï∑Ô∏è Data Collection Pipeline"
        direction TB
        Collect1["‚è∞ Cron: Every 6 hrs<br/>Manual: Admin Trigger"] --> Collect2["Fetch Supplier<br/>List from DB"]
        Collect2 --> Collect3["Parallel Scraping:<br/>10 Concurrent Jobs"]
        
        subgraph "6a. Web Scraping"
            Web1["Fetch HTML<br/>with Rotating UA"] --> Web2["Parse with<br/>Cheerio/Puppeteer"]
            Web2 --> Web3["Extract<br/>Price Tables"]
        end
        
        subgraph "6b. PDF Processing"
            PDF1["Download PDF"] --> PDF2["OCR with<br/>Tesseract/PDF.js"]
            PDF2 --> PDF3["Parse Tables<br/>with Regex/ML"]
        end
        
        Collect3 --> Web1
        Collect3 --> PDF1
        
        Web3 --> Validate["Data Validation:<br/>‚Ä¢ Schema check<br/>‚Ä¢ Range check<br/>‚Ä¢ Duplicate check"]
        PDF3 --> Validate
        
        Validate --> Valid{"Valid?"}
        Valid -->|Yes| StoreDB["Bulk Insert to<br/>PostgreSQL (Batch)"]
        Valid -->|No| LogError["Log Error to<br/>Monitoring System"]
        
        StoreDB --> InvalidateCache["üöÄ Invalidate Redis<br/>Keys for Supplier"]
        InvalidateCache --> Notify["Notify WebSocket:<br/>'Data Updated'"]
    end

    subgraph "7. üì± Mobile Offline Mode"
        direction TB
        Offline1["üì¥ Connectivity Lost"] --> Offline2["Switch to<br/>Offline Mode"]
        Offline2 --> Offline3["User Searches<br/>Materials"]
        Offline3 --> Offline4["Query Hive Local DB<br/>+ SQLite Cache"]
        Offline4 --> Offline5["Display Results<br/>with 'Offline' Badge"]
        
        Offline5 --> Offline6["User Favorites<br/>Material"]
        Offline6 --> Offline7["Save to Hive<br/>with Sync Flag"]
        
        Offline7 --> Offline8["üì∂ Connectivity<br/>Restored"]
        Offline8 --> Offline9["Background Sync<br/>Queue Processor"]
        
        subgraph "7a. Sync Engine"
            Sync1["Read Pending<br/>Changes"] --> Sync2["POST to API<br/>with Retry Logic"]
            Sync2 --> Sync3{"Conflict?"}
            Sync3 -->|Yes| Sync4["Server Version Wins<br/>‚Ä¢ Log conflict<br/>‚Ä¢ Notify user"]
            Sync3 -->|No| Sync5["Update Local<br/>Sync Timestamp"]
        end
        
        Offline9 --> Sync1
        Sync5 --> Offline10["Download Latest<br/>Favorites from Server"]
        Offline10 --> Offline11["Merge & Update<br/>Local Cache"]
    end

    %% Cross-subgraph connections
    API --> Auth1
    Auth8 --> Price1
    Auth8 --> Miss1
    Auth8 --> ML1
    Auth8 --> MLC1
    
    StoreDB --> InvalidateCache
    InvalidateCache --> Price3
    InvalidateCache --> Miss2

    %% Styling
    classDef auth fill:#FF6B6B,stroke:#8B0000,stroke-width:2px,color:white,font-weight:bold
    classDef price fill:#4ECDC4,stroke:#2F8F8F,stroke-width:2px,color:black,font-weight:bold
    classDef ml fill:#95E1D3,stroke:#2F8F8F,stroke-width:2px,color:black,font-weight:bold
    classDef scrape fill:#F38181,stroke:#8B0000,stroke-width:2px,color:white,font-weight:bold
    classDef offline fill:#AA96DA,stroke:#5D4A8F,stroke-width:2px,color:white,font-weight:bold
    classDef gateway fill:#FFE3E0,stroke:#333,stroke-width:3px,color:#333,font-weight:bold
    
    class Auth1,Auth2,Auth3,Auth4,Auth5,Auth6,Auth7,Auth8,Auth9,Auth10,Auth11,Auth12 auth
    class Price1,Price2,Price3,Price4,Price5,Price6 price
    class Miss1,Miss2,Miss3,Miss4,Miss5,Miss6,Miss7,Miss8 price
    class ML1,ML2,ML3,ML4,ML5,ML6,ML7,ML8,ML9,MLC1,MLC2,MLC3,MLC4,MLC5 ml
    class Collect1,Collect2,Collect3,Web1,Web2,Web3,PDF1,PDF2,PDF3,Validate,Valid,LogError,StoreDB,InvalidateCache,Notify scrape
    class Offline1,Offline2,Offline3,Offline4,Offline5,Offline6,Offline7,Offline8,Offline9,Offline10,Offline11,Sync1,Sync2,Sync3,Sync4,Sync5 offline
    class API,Client gateway
